name: Render HTML → DOCX / PDF / TXT (commit to branch)

on:
  push:
    paths:
      - '**/*.html'
  workflow_dispatch:

permissions:
  contents: write

jobs:
  render:
    if: github.ref != 'refs/heads/rendered-artifacts'
    name: Render HTML files and commit
    runs-on: ubuntu-latest
    container:
      image: pandoc/latex:3.1
      options: --user root

    steps:
      - name: Install Git in container
        run: |
          apk add --no-cache git

      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          fetch-depth: 0
          persist-credentials: true

      - name: Find HTML files under languages/
        id: find_html
        run: |
          git ls-files '*.html' | grep '^languages/' | grep -v '/index.html$' > html_list.txt || true
          if [ ! -s html_list.txt ]; then
            echo "no_html=true" >> $GITHUB_OUTPUT
            echo "No HTML files found under languages/."
          else
            echo "no_html=false" >> $GITHUB_OUTPUT
            echo "Found HTML files:"
            cat html_list.txt
          fi

      - name: Convert HTML to DOCX, PDF, TXT
        if: steps.find_html.outputs.no_html != 'true'
        run: |
          set -euo pipefail
          rm -rf out
          mkdir -p out
          
          while IFS= read -r html; do
            [ -z "$html" ] && continue
            if [ "$(basename "$html")" = "index.html" ]; then
              echo "Skipping index: $html"
              continue
            fi

            lang="$(echo "$html" | cut -d'/' -f2)"
            rel_after_lang="${html#languages/$lang/}"
            name_no_ext="${rel_after_lang%.html}"
            safe_name="$(echo "$name_no_ext" | tr '/' '_')"
            outbase="${lang}_${safe_name}"
            outdir="out"
            mkdir -p "$outdir"

            echo "Rendering $html → $outdir/${outbase}.{docx,pdf,txt}"

            pandoc "$html" -f html -t docx -o "$outdir/${outbase}.docx"
            pandoc "$html" -f html -t plain -o "$outdir/${outbase}.txt"
            pandoc "$html" -f html -o "$outdir/${outbase}.pdf" --pdf-engine=xelatex -V geometry:margin=1in
          done < html_list.txt

      - name: Commit to rendered-artifacts branch
        if: steps.find_html.outputs.no_html != 'true'
        run: |
          set -euo pipefail
          
          git config user.name "github-actions[bot]"
          git config user.email "41898282+github-actions[bot]@users.noreply.github.com"
          git remote set-url origin "https://x-access-token:${{ secrets.GITHUB_TOKEN }}@github.com/${{ github.repository }}.git"

          if git fetch origin rendered-artifacts:rendered-artifacts 2>/dev/null; then
            git checkout rendered-artifacts
          else
            git checkout --orphan rendered-artifacts
            git rm -rf . || true
          fi

          rm -rf rendered-docs
          mkdir -p rendered-docs
          cp -a out/. rendered-docs/
          git add -A rendered-docs

          if git diff --staged --quiet; then
            echo "No changes to commit."
            exit 0
          fi

          timestamp="$(date -u +%Y-%m-%dT%H:%M:%SZ)"
          git commit -m "Rendered docs: $timestamp [skip ci]"
          git push origin rendered-artifacts

      - name: Show pushed files
        if: steps.find_html.outputs.no_html != 'true'
        run: |
          echo "Files in rendered-docs/:"
          find rendered-docs -type f -print 2>/dev/null || echo "No files found"
